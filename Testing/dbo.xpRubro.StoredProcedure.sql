GOQUOTED_IDENTIFIER OFFGOCREATE PROCEDURE [dbo].[xpRubro]@Agente   VARCHAR(10),@Institucion VARCHAR(10),@Equipo   VARCHAR(10),  @Familia  VARCHAR(50),  @Categoria  VARCHAR(50),  @Desde1   INT,@Hasta1   INT,@Desde2   INT,@Hasta2   INT,@Desde3   INT,@Hasta3   INTAS BEGINNOCOUNT ONDECLARE@Qna INT,@Iqc CHAR(3),@Fqc CHAR(3),@Iac CHAR(3),@Fac CHAR(3),     @Qc1 DATETIME,     @Qc2 DATETIME,     @Qa1 DATETIME,@Qa2 DATETIME,@R1  CHAR(8),@R2  CHAR(8),@M1  CHAR(16),@M2  CHAR(16),@RD1 CHAR(9),@RD2 CHAR(9),@RD3 CHAR(9),@Mes CHAR(2),@Anio CHAR(4),@MesAnt CHAR(2)@RD1=CAST(@Desde1 AS CHAR(3))+' - '+CAST(@Hasta1 AS CHAR(3)) @RD2=CAST(@Desde2 AS CHAR(3))+' - '+CAST(@Hasta2 AS CHAR(3)) @RD3=CAST(@Desde3 AS CHAR(3))+' - '+CAST(@Hasta3 AS CHAR(3)) @Qna = (SELECT dbo.fnperiodosmavi(GETDATE()))IF @Qna = 1 BEGIN@Qna = 25@Anio= (SELECT CAST(YEAR(GETDATE()) - 1 AS CHAR(4)))ENDELSEBEGIN@Anio= (SELECT CAST(YEAR(GETDATE()) AS CHAR(4)))END@Mes= (SELECT CAST(@Qna AS CHAR(2)))@MesAnt= (SELECT CAST((@Qna -1 ) AS CHAR(2)))@Qc1= (SELECT dbo.fninicioquincenaMavi (@Mes,@Anio))@Qc2= (SELECT dbo.fnfinquincenamavi(@Mes,@Anio))@Qa1= (SELECT dbo.fninicioquincenaMavi (@MesAnt,@Anio))@Qa2= (SELECT dbo.fnfinquincenamavi(@MesAnt,@Anio))@R1=CAST(DATEPART(DAY,@Qc1) AS CHAR(2))+' - '+CAST(DATEPART(DAY,@Qc2) AS CHAR(2))@R2=CAST(DATEPART(DAY,@Qa1) AS CHAR(2))+' - '+CAST(DATEPART(DAY,@Qa2) AS CHAR(2))LANGUAGE SPANISH@M1=DATENAME(MONTH,@Qc1)@M2=DATENAME(MONTH,@Qa1)LANGUAGE ENGLISHCREATE TABLE #TablaA(Documento VARCHAR(50) COLLATE Database_Default NULL, Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL, CV INT NULL,DV INT NULL)INSERT #TablaA (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV, DV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(rm.Quincena), c.Origen, c.OrigenID, rm.CanalVenta, rm.DiasVencidosFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=(@Qna-1) AND rm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.AgenteCobrador<>'SIN AGENTE' and c.Estatus <> 'CANCELADO'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVenta, rm.DiasVencidosUPDATE #TablaA  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaB(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL, Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL ,CV INT NULL, DV INT NULL)INSERT #TablaB (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV, DV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(rm.Quincena), c.Origen, c.OrigenID, rm.CanalVenta, rm.DiasVencidosFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 AND rm.AgenteCobrador<>'SIN AGENTE' ANDrm.Quincena=CASE WHEN (@Qna-2)=0 THEN 24 ELSE @Qna-2 END ANDrm.CanalVenta=vc.ID AND vc.Categoria=@CategoriaGROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVenta, rm.DiasVencidosUPDATE #TablaB  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaC(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL, Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL, Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaC (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(rm.Quincena), c.Origen, c.OrigenID, rm.CanalVentaFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=(@Qna-1) AND rm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.DiasVencidos BETWEEN @Desde1 AND @Hasta1 AND rm.AgenteCobrador<>'SIN AGENTE'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVentaUPDATE #TablaC  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaE(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL, Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL, NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaE (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(Quincena), c.Origen, c.OrigenID, rm.CanalVentaFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=CASE WHEN (@Qna-2)=0 THEN 24 ELSE @Qna-2 END ANDrm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.DiasVencidos BETWEEN @Desde1 AND @Hasta1 AND rm.AgenteCobrador<>'SIN AGENTE'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVentaUPDATE #TablaE  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaC1(Documento VARCHAR(50) COLLATE Database_Default NULL, Numero VARCHAR(50) COLLATE Database_Default NULL, Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL, Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaC1 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(rm.Quincena), c.Origen, c.OrigenID, rm.CanalVentaFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=(@Qna-1) AND rm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.DiasVencidos BETWEEN @Desde2 AND @Hasta2 AND rm.AgenteCobrador<>'SIN AGENTE'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVentaUPDATE #TablaC1  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaE1(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaE1 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(Quincena), c.Origen, c.OrigenID, rm.CanalVentaFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=CASE WHEN (@Qna-2)=0 THEN 24 ELSE @Qna-2 END ANDrm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.DiasVencidos BETWEEN @Desde2 AND @Hasta2 AND rm.AgenteCobrador<>'SIN AGENTE'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVentaUPDATE #TablaE1  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaC2(Documento VARCHAR(50) COLLATE Database_Default NULL, Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaC2 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(rm.Quincena), c.Origen, c.OrigenID, rm.CanalVentaFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=(@Qna-1) AND rm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.DiasVencidos BETWEEN @Desde3 AND @Hasta3 AND rm.AgenteCobrador<>'SIN AGENTE'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVentaUPDATE #TablaC2  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''CREATE TABLE #TablaE2(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL, Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaE2 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTrm.Documento, rm.Numero, rm.AgenteCobrador, 'Referencia'=c.Origen+' '+c.OrigenID, MAX(Quincena), c.Origen, c.OrigenID, rm.CanalVentaFROMMaviRecuperacion rm,Cxc c,VentasCanalMavi vcWHERErm.Documento=c.Mov AND rm.Numero=c.MovID AND ISNULL(c.Saldo,0)>=0 ANDrm.Quincena=CASE WHEN (@Qna-2)=0 THEN 24 ELSE @Qna-2 END ANDrm.CanalVenta=vc.ID AND vc.Categoria=@Categoria ANDrm.DiasVencidos BETWEEN @Desde3 AND @Hasta3 AND rm.AgenteCobrador<>'SIN AGENTE'GROUP BYc.Origen, c.OrigenID, rm.Numero, rm.AgenteCobrador, rm.Documento, rm.CanalVentaUPDATE #TablaE2  Referencia=Documento+' '+Numero,Factura=Documento, NFactura=Numero WHERE ISNULL(Referencia,'')=''DELETE FROM #TablaC WHERE Referencia IN (SELECT Referencia FROM #TablaA WHERE DV>@Hasta1)DELETE FROM #TablaC1 WHERE Referencia IN (SELECT Referencia FROM #TablaA WHERE DV>@Hasta2)DELETE FROM #TablaC2 WHERE Referencia IN (SELECT Referencia FROM #TablaA WHERE DV>@Hasta3)DELETE FROM #TablaE WHERE Referencia IN (SELECT Referencia FROM #TablaB WHERE DV>@Hasta1)DELETE FROM #TablaE1 WHERE Referencia IN (SELECT Referencia FROM #TablaB WHERE DV>@Hasta2)DELETE FROM #TablaE2 WHERE Referencia IN (SELECT Referencia FROM #TablaB WHERE DV>@Hasta3)CREATE TABLE #TablaG(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL, Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaG(Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTe.Documento, e.Numero, e.Agente, e.Referencia, e.Quincena, e.Factura, e.NFactura, e.CVFROM#TablaC c, #TablaE eWHEREc.Factura=e.Factura AND c.NFactura=e.NFactura AND c.Agente=e.AgenteCREATE TABLE #TablaSalieron(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL, Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaSalieron (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTDocumento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CVFROM#TablaEWHEREReferencia NOT IN (SELECT Referencia FROM #TablaG)CREATE TABLE #TablaJ(Mov CHAR(20) COLLATE Database_Default NULL,MovID VARCHAR(20) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL)INSERT #TablaJ (Mov, MovID, Agente)SELECT DISTINCTc.Mov, c.MovID, c.AgenteFROMCxc cWHEREc.Mov IN('Nota Credito','Nota Credito VIU','Cancela Credilana','Cancela Prestamo') AND c.Concepto IN('ADJUDICACION + DE 12','ADJUDICACION 1 A 12','OK ADJUDICACION + DE 12','OK ADJUDICACION 1 A 12','OK ADJ CREDILANA/PP + DE 12','ADJ CREDILANA/PP + DE 12') AND c.Estatus='CONCLUIDO' ANDc.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDISNULL(c.Agente,'')<>''AND EXISTS(SELECT tc.referencia FROM #TablaC tc, CxcD dwhere c.id=d.id and tc.documento=d.aplica  and tc.numero=d.aplicaid)CREATE TABLE #TablaM(Origen VARCHAR(50) COLLATE Database_Default NULL,OrigenID VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10)  COLLATE Database_Default NULL)INSERT #TablaM (Origen, OrigenID, Agente)SELECTISNULL(c2.Origen,c2.Mov), ISNULL(c2.OrigenID,c2.MovID), e.AgenteFROMCxc cJOIN CxcD dON c.ID=d.IDJOIN Cxc c2ON d.Aplica=c2.Mov AND d.AplicaID=c2.MovIDJOIN EmbarqueMov emON d.Aplica=em.Mov AND d.AplicaID=em.MovIDJOIN Embarqued edON em.id=ed.embarquemov JOIN Embarque eON e.id = ed.id WHEREc.Estatus='CONCLUIDO' ANDc.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDe.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDc.Mov='Cobro' ANDISNULL(c.Saldo,0)=0 ANDISNULL(c2.OrigenID,c2.MovID) IN (SELECT NFactura FROM #TablaSalieron)INSERT #TablaM(Origen, OrigenID, Agente)SELECT DISTINCTs.Factura, s.NFactura, s.AgenteFROM#TablaSalieron s,Cxc c2WHEREs.Documento=c2.Mov AND s.Numero=c2.MovID AND ISNULL(c2.Saldo,0)>0 ANDc2.Estatus IN('CONCLUIDO') AND c2.FechaEmision<>c2.UltimoCambio ANDc2.UltimoCambio BETWEEN @Qc1 AND @Qc2CREATE TABLE #TablaG1(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL, Quincena INT NULL, Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL) INSERT #TablaG1 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTe.Documento, e.Numero, e.Agente, e.Referencia, e.Quincena, e.Factura, e.NFactura, e.CVFROM#TablaC1 c, #TablaE1 eWHEREc.Factura=e.Factura AND c.NFactura=e.NFactura AND c.Agente=e.AgenteCREATE TABLE #TablaSalieron1(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaSalieron1 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTDocumento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CVFROM#TablaE1WHERENFactura NOT IN (SELECT NFactura FROM #TablaG1)CREATE TABLE #TablaJ1(Mov CHAR(20) COLLATE Database_Default NULL,MovID VARCHAR(20) COLLATE Database_Default NULL, Agente VARCHAR(10) COLLATE Database_Default NULL)INSERT #TablaJ1 (Mov, MovID, Agente)SELECT DISTINCTc.Mov, c.MovID, c.AgenteFROMCxc cWHEREc.Mov IN('Nota Credito','Nota Credito VIU','Cancela Credilana','Cancela Prestamo') AND c.Concepto IN('ADJUDICACION + DE 12','ADJUDICACION 1 A 12','OK ADJUDICACION + DE 12','OK ADJUDICACION 1 A 12','OK ADJ CREDILANA/PP + DE 12','ADJ CREDILANA/PP + DE 12') AND c.Estatus='CONCLUIDO' ANDc.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDISNULL(c.Agente,'')<>'' AND EXISTS(SELECT c1.referencia FROM #TablaC1 c1, CxcD dwhere c.id=d.id and c1.documento=d.aplica  and c1.numero=d.aplicaid)CREATE TABLE #TablaM1(Origen VARCHAR(50) COLLATE Database_Default NULL, OrigenID VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL)INSERT #TablaM1 (Origen, OrigenID, Agente)SELECTISNULL(c2.Origen,c2.Mov), ISNULL(c2.OrigenID,c2.MovID), e.AgenteFROMCxc cJOIN CxcD dON c.ID=d.IDJOIN Cxc c2ON d.Aplica=c2.Mov AND d.AplicaID=c2.MovIDJOIN EmbarqueMov emON d.Aplica=em.Mov AND d.AplicaID=em.MovIDJOIN Embarqued edON em.id=ed.embarquemov JOIN Embarque eON e.id = ed.id WHEREc.Estatus='CONCLUIDO' ANDc.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDe.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDc.Mov='Cobro' ANDISNULL(c.Saldo,0)=0 ANDISNULL(c2.OrigenID,c2.MovID) IN (SELECT NFactura FROM #TablaSalieron1)INSERT #TablaM1 (Origen, OrigenID, Agente) SELECT DISTINCTs.Factura, s.NFactura, s.AgenteFROM#TablaSalieron1 s,Cxc c2WHEREs.Documento=c2.Mov AND s.Numero=c2.MovID AND ISNULL(c2.Saldo,0)>0 ANDc2.Estatus='Concluido' AND c2.FechaEmision<>c2.UltimoCambio ANDc2.UltimoCambio BETWEEN @Qc1 AND @Qc2CREATE TABLE #TablaG2(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL,Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaG2 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTe.Documento, e.Numero, e.Agente, e.Referencia, e.Quincena, e.Factura, e.NFactura, e.CVFROM#TablaC2 c, #TablaE2 eWHEREc.Factura=e.Factura AND c.NFactura=e.NFactura AND c.Agente=e.AgenteCREATE TABLE #TablaSalieron2(Documento VARCHAR(50) COLLATE Database_Default NULL,Numero VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL,Referencia VARCHAR(100) COLLATE Database_Default NULL,Quincena INT NULL, Factura VARCHAR(50) COLLATE Database_Default NULL,NFactura VARCHAR(50) COLLATE Database_Default NULL,CV INT NULL)INSERT #TablaSalieron2 (Documento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CV)SELECT DISTINCTDocumento, Numero, Agente, Referencia, Quincena, Factura, NFactura, CVFROM#TablaE2WHEREReferencia NOT IN (SELECT Referencia FROM #TablaG2)CREATE TABLE #TablaJ2(Mov CHAR(20) COLLATE Database_Default NULL,MovID VARCHAR(20) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL)INSERT #TablaJ2 (Mov, MovID, Agente)SELECT DISTINCTc.Mov, c.MovID, c.AgenteFROMCxc cWHEREc.Mov IN('Nota Credito','Nota Credito VIU','Cancela Credilana','Cancela Prestamo') AND c.Concepto IN('ADJUDICACION + DE 12','ADJUDICACION 1 A 12','OK ADJUDICACION + DE 12','OK ADJUDICACION 1 A 12','OK ADJ CREDILANA/PP + DE 12','ADJ CREDILANA/PP + DE 12') AND c.Estatus='CONCLUIDO' ANDc.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDISNULL(c.Agente,'')<>'' AND EXISTS(SELECT c2.referencia FROM #TablaC2 c2, CxcD dwhere c.id=d.id and c2.documento=d.aplica  and c2.numero=d.aplicaid)CREATE TABLE #TablaM2(Origen VARCHAR(50) COLLATE Database_Default NULL,OrigenID VARCHAR(50) COLLATE Database_Default NULL,Agente VARCHAR(10) COLLATE Database_Default NULL)INSERT #TablaM2 (Origen, OrigenID, Agente)SELECTISNULL(c2.Origen,c2.Mov), ISNULL(c2.OrigenID,c2.MovID), e.AgenteFROMCxc cJOIN CxcD dON c.ID=d.IDJOIN Cxc c2ON d.Aplica=c2.Mov AND d.AplicaID=c2.MovIDJOIN EmbarqueMov emON d.Aplica=em.Mov AND d.AplicaID=em.MovIDJOIN Embarqued edON em.id=ed.embarquemov JOIN Embarque eON e.id = ed.id WHEREc.Estatus='CONCLUIDO' ANDc.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDe.FechaEmision BETWEEN @Qc1 AND @Qc2 ANDc.Mov='Cobro' ANDISNULL(c.Saldo,0)=0 ANDISNULL(c.OrigenID,c2.MovID) IN (SELECT NFactura FROM #TablaSalieron2)INSERT #TablaM2 (Origen, OrigenID, Agente)SELECT DISTINCTs.Factura, s.NFactura, s.AgenteFROM#TablaSalieron2 s,Cxc c2WHEREs.Documento=c2.Mov AND s.Numero=c2.MovID AND ISNULL(c2.Saldo,0)>0 ANDc2.Estatus='Concluido' AND c2.FechaEmision<>c2.UltimoCambio ANDc2.UltimoCambio BETWEEN @Qc1 AND @Qc2CREATE TABLE #TablaTotal(Codigo VARCHAR(10) COLLATE Database_Default NULL, Nombre VARCHAR(100) COLLATE Database_Default NULL, CampoA INT NULL, CampoB INT NULL, CampoC INT NULL, CampoE INT NULL,CampoG INT NULL, CampoSalieron INT NULL, CampoJ INT NULL, CampoM INT NULL, CampoC1 INT NULL, CampoE1 INT NULL, CampoG1 INT NULL, CampoSalieron1 INT NULL,CampoJ1 INT NULL, CampoM1 INT NULL, CampoC2 INT NULL, CampoE2 INT NULL, CampoG2 INT NULL, CampoSalieron2 INT NULL, CampoJ2 INT, CampoM2 INT NULL,Celula VARCHAR(10) COLLATE Database_Default NULL, Equipo VARCHAR(10) COLLATE Database_Default NULL, Familia VARCHAR(50) COLLATE Database_Default NULL, Categoria VARCHAR(50) COLLATE Database_Default NULL, RD1 CHAR(9) COLLATE Database_Default NULL,RD2 CHAR(9)COLLATE Database_Default NULL, RD3 CHAR(9) COLLATE Database_Default NULL, R1 CHAR(8) COLLATE Database_Default NULL, R2 CHAR(8) COLLATE Database_Default NULL, M1 CHAR(16) COLLATE Database_Default NULL, M2 CHAR(16) COLLATE Database_Default NULL)IF (@Categoria='Credito Menudeo' OR @Categoria='ASOCIADOS')BEGININSERT #TablaTotal (Codigo, Nombre, CampoA, CampoB, CampoC, CampoE, CampoG, CampoSalieron, CampoJ, CampoM, CampoC1,CampoE1, CampoG1, CampoSalieron1, CampoJ1, CampoM1, CampoC2, CampoE2, CampoG2, CampoSalieron2, CampoJ2, CampoM2,Equipo, Familia, Categoria, Celula, RD1, RD2, RD3, R1, R2, M1, M2)SELECTag.Agente,ag.Nombre,'CampoA'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaA WHERE Agente=ag.Agente),'CampoB'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaB WHERE Agente=ag.Agente),'CampoC'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaC WHERE Agente=ag.Agente),'CampoE'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaE WHERE Agente=ag.Agente),'CampoG'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaG WHERE Agente=ag.Agente),'CampoSalieron'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaSalieron WHERE Agente=ag.Agente),'CampoJ'=(SELECT COUNT(Mov) FROM #TablaJ WHERE Agente=ag.Agente),'CampoM'=(SELECT COUNT(Origen) FROM #TablaM WHERE Agente=ag.Agente),'CampoC1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaC1 WHERE Agente=ag.Agente),'CampoE1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaE1 WHERE Agente=ag.Agente),'CampoG1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaG1 WHERE Agente=ag.Agente),'CampoSalieron1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaSalieron1 WHERE Agente=ag.Agente),'CampoJ1'=(SELECT COUNT(Mov) FROM #TablaJ1 WHERE Agente=ag.Agente),'CampoM1'=(SELECT COUNT(Origen) FROM #TablaM1 WHERE Agente=ag.Agente),'CampoC2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaC2 WHERE Agente=ag.Agente),'CampoE2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaE2 WHERE Agente=ag.Agente),'CampoG2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaG2 WHERE Agente=ag.Agente),'CampoSalieron2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaSalieron2 WHERE Agente=ag.Agente),'CampoJ2'=(SELECT COUNT(Mov) FROM #TablaJ2 WHERE Agente=ag.Agente),'CampoM2'=(SELECT COUNT(Origen) FROM #TablaM2 WHERE Agente=ag.Agente),'Equipo'=ISNULL(ea.Equipo,''),ag.Familia,ag.Categoria,'Celula'=(SELECT Equipo FROM EquipoAgente WHERE Agente=ea.Equipo),@RD1, @RD2, @RD3, @R1, @R2, @M1, @M2FROMAgente ag LEFT OUTER JOIN EquipoAgente eaONag.Agente=ea.AgenteUPDATE #TablaTotal  Celula='' WHERE ISNULL(Celula,'')=''IF (@Agente='' AND @Equipo='' AND @Familia='')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0)ORDER BY Equipo, FamiliaENDELSE IF (@Agente<>'')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND Codigo=@AgenteORDER BY Equipo, FamiliaENDELSE IF (@Equipo<>'')BEGINIF (@Familia<>'')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND (Equipo=@Equipo OR Celula=@Equipo) AND Familia=@FamiliaORDER BY Equipo, FamiliaENDELSEBEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND (Equipo=@Equipo OR Celula=@Equipo)ORDER BY Equipo, FamiliaENDENDELSE IF (@Familia<>'')BEGINIF (@Equipo<>'')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND (Equipo=@Equipo OR Celula=@Equipo) AND Familia=@FamiliaORDER BY Equipo, FamiliaENDELSEBEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND Familia=@FamiliaORDER BY Equipo, FamiliaENDENDENDELSEBEGININSERT #TablaTotal(Codigo, Nombre, CampoA, CampoB, CampoC, CampoE, CampoG, CampoSalieron, CampoJ, CampoM, CampoC1,CampoE1, CampoG1, CampoSalieron1, CampoJ1, CampoM1, CampoC2, CampoE2, CampoG2, CampoSalieron2, CampoJ2, CampoM2,Equipo, Familia, Categoria, Celula, RD1, RD2, RD3, R1, R2, M1, M2)SELECTag.Agente,ag.Nombre,'CampoA'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaA WHERE Agente=ag.Agente),'CampoB'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaB WHERE Agente=ag.Agente),'CampoC'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaC WHERE Agente=ag.Agente),'CampoE'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaE WHERE Agente=ag.Agente),'CampoG'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaG WHERE Agente=ag.Agente),'CampoSalieron'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaSalieron WHERE Agente=ag.Agente),'CampoJ'=(SELECT COUNT(Mov) FROM #TablaJ WHERE Agente=ag.Agente),'CampoM'=(SELECT COUNT(Origen) FROM #TablaM WHERE Agente=ag.Agente),'CampoC1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaC1 WHERE Agente=ag.Agente),'CampoE1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaE1 WHERE Agente=ag.Agente),'CampoG1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaG1 WHERE Agente=ag.Agente),'CampoSalieron1'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaSalieron1 WHERE Agente=ag.Agente),'CampoJ1'=(SELECT COUNT(Mov) FROM #TablaJ1 WHERE Agente=ag.Agente),'CampoM1'=(SELECT COUNT(Origen) FROM #TablaM1 WHERE Agente=ag.Agente),'CampoC2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaC2 WHERE Agente=ag.Agente),'CampoE2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaE2 WHERE Agente=ag.Agente),'CampoG2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaG2 WHERE Agente=ag.Agente),'CampoSalieron2'=(SELECT COUNT(DISTINCT(Referencia)) FROM #TablaSalieron2 WHERE Agente=ag.Agente),'CampoJ2'=(SELECT COUNT(Mov) FROM #TablaJ2 WHERE Agente=ag.Agente),'CampoM2'=(SELECT COUNT(Origen) FROM #TablaM2 WHERE Agente=ag.Agente),'Equipo'=(SELECT TOP(1) vc.Cadena FROM VentasCanalMavi vc, #TablaA a WHERE a.CV=vc.ID and a.Agente=ag.Agente),'','Categoria'=(SELECT TOP(1) vc.Categoria FROM VentasCanalMavi vc, #TablaA a WHERE a.CV=vc.ID and a.Agente=ag.Agente),'Celula'='',@RD1, @RD2, @RD3, @R1, @R2, @M1, @M2FROMAgente agIF (@Agente='' AND @Institucion='')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0)ORDER BY EquipoENDELSE IF (@Agente<>'')BEGINIF (@Institucion='')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND Codigo=@AgenteORDER BY EquipoENDELSEBEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND Codigo=@Agente AND Equipo=(SELECT Cadena FROM VentasCanalMavi WHERE Clave=@Institucion)ORDER BY EquipoENDENDELSE IF (@Institucion<>'')BEGINIF (@Agente='')BEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND Equipo=(SELECT Cadena FROM VentasCanalMavi WHERE Clave=@Institucion)ORDER BY EquipoENDELSEBEGINSELECT * FROM #TablaTotal WHERE (CampoA<>0 OR CampoB<>0) AND Equipo=(SELECT Cadena FROM VentasCanalMavi WHERE Clave=@Institucion) AND Codigo=@AgenteORDER BY EquipoENDENDENDDROP TABLE #tablaaDROP TABLE #tablabDROP TABLE #tablacDROP TABLE #tablaeDROP TABLE #tablac1DROP TABLE #tablae1DROP TABLE #tablac2DROP TABLE #tablae2DROP TABLE #tablagDROP TABLE #tablasalieronDROP TABLE #tablaj    DROP TABLE #tablamDROP TABLE #tablag1DROP TABLE #tablasalieron1DROP TABLE #tablaj1DROP TABLE #tablam1DROP TABLE #tablag2DROP TABLE #tablasalieron2DROP TABLE #tablaj2DROP TABLE #tablam2DROP TABLE #tablatotalENDGO